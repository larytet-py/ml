<!DOCTYPE html>
<html>
<head>
    <title>Financial Chart</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script src="https://code.highcharts.com/stock/highstock.js"></script>
    <script src="https://code.highcharts.com/stock/modules/data.js"></script>
    <script src="https://code.highcharts.com/stock/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/stock/modules/accessibility.js"></script>
</head>
<body>
    <div style="margin-bottom: 10px;">
        <input type="text" id="startTimePicker" placeholder="Select Start Time" />
        <input type="number" id="duration" placeholder="Duration (hours)" min="1" max="72" />
        <button onclick="loadConfigAndData()">Load Data</button>
    </div>
    <!-- Container divs will be dynamically created here -->
    <script>
        // jQuery is a popular JavaScript library for simplifying HTML document traversing,
        // event handling, and AJAX interactions. The "$" symbol is an alias for "jQuery".
        // Everything inside $(function() {...}) will run once the document is fully loaded.
        $(function() {
            // Selects the HTML element with the ID 'startTimePicker' and applies a date range picker plugin.
            // This plugin provides a user-friendly interface for date picking in web forms.
            $('#startTimePicker').daterangepicker({
                // Configures the date range picker to behave as a single date picker with time selection.
                singleDatePicker: true,
                timePicker: true, // Enables time selection.
                timePicker24Hour: true, // Sets time format to 24-hour clock.
                timePickerIncrement: 15, // Sets the increment of minutes selection to 15 minutes.
                startDate: moment().subtract(24, 'days'), // Default starting date is 4 days before the current day.
                locale: {
                    format: 'YYYY-MM-DDTHH:mm:ss.SSS[Z]' // Sets the format for displaying selected dates.
                }
            });
    
            // Sets the default value of the HTML input element with ID 'duration' to 2.
            $('#duration').val(2);
    
            // Calls a function to load configuration and data when the page is ready.
            loadConfigAndData();
        });
    
        // Defines a function to load configuration and data.
        function loadConfigAndData() {
            // Fetch API is used to make an HTTP request to retrieve 'panels.json'.
            fetch('panels.json')
                .then(response => response.json()) // Parses the response as JSON.
                .then(panels => {
                    // Iterates over each panel object in the 'panels' array.
                    panels.forEach(panel => {
                        // Creates a unique container ID by modifying the panel title. Removes non-alphanumeric characters.
                        var containerId = 'container_' + panel.title.replace(/[^a-zA-Z0-9]/g, '_');
                        // Creates a new <div> element and sets its attributes for ID and CSS styles.
                        var containerDiv = $('<div>').attr('id', containerId).css({
                            height: '600px',
                            minWidth: '310px',
                            marginBottom: '20px'
                        });
                        // Appends the newly created <div> to the body of the HTML document.
                        $('body').append(containerDiv);
                        // Calls a function to load data for each panel using the container ID.
                        loadData(panel, containerId);
                    });
                })
                .catch(error => {
                    // Logs an error message in the console if the fetch operation fails.
                    console.error('Error loading panel config:', error);
                });
        }
    
        // Defines a function to load data for a specific panel.
        function loadData(panel, containerId) {
            // Retrieves the start time from the input with ID 'startTimePicker'.
            var startTime = moment.utc($('#startTimePicker').val());
            // Retrieves and converts the duration (in hours) from the input with ID 'duration' to an integer.
            var duration = parseInt($('#duration').val());
            // Calculates the end time by adding the duration to the start time.
            var endTime = moment(startTime).add(duration, 'minutes');
    
            // Iterates over each endpoint specified in the panel's configuration.
            panel.endpoints.forEach(endpoint => {
                // Calls a function to fetch data from each endpoint.
                fetchData(panel.symbol, startTime.format('YYYY-MM-DDTHH:mm:ss.SSS[Z]'), endTime.format('YYYY-MM-DDTHH:mm:ss.SSS[Z]'), endpoint.type, endpoint.url, panel.interval, containerId, panel.title);
            });
        }
    
        // Defines a function to fetch data from a specified endpoint.
        function fetchData(symbol, startDate, endDate, type, url, interval, containerId, title, addData = false) {
            // Logs the data fetching details to the console.
            console.log(`Fetching data: ${symbol}, Start: ${startDate}, End: ${endDate}`);
            // Makes an HTTP GET request to fetch data. Encodes query parameters to ensure URL validity.
            fetch(`${url}?symbol=${encodeURIComponent(symbol)}&start=${encodeURIComponent(startDate)}&end=${encodeURIComponent(endDate)}&interval=${{interval}}`)
                .then(response => response.json()) // Parses the response as JSON.
                .then(data => {
                    // Processes the received data based on the type of data representation (line or OHLC chart).
                    // The `seriesData` constant is assigned the result of the `map` method called on the `data` array.
                    // `map` is used to transform each item in the original `data` array into a new format suitable for chart representation.
                    // Each `item` in `data` is expected to contain data points with properties like time, price, and possibly open, high, low, close values for OHLC charts.
                    // The arrow function `(item => { ... })` passed to `map` is executed for each element of `data`:
                    // - Inside the arrow function, conditional logic checks the 'type' to format the data appropriately:
                    //   - If `type` is 'line', the function transforms the item into a new array containing the item's time as a timestamp and its price.
                    //   - If `type` is 'ohlc', the function transforms the item into a new array with the item's time as a timestamp followed by its open, high, low, and close values.
                    // This transformation is crucial for the Highcharts library used later to render the data accurately in the specified chart type.
                    // The `map` method returns a new array consisting of these transformed items, which is then assigned to `seriesData`.
                    const seriesData = data.map(item => {
                        if (type === 'line') {
                            return [item.time, item.price];
                        } else if (type === 'scatter') {
                            return [item.time, item.price];
                        } else if (type === 'candlestick') {
                            return [item.time, item.open, item.high, item.low, item.close];
                        }
                    // The .sort((a, b) => a[0] - b[0]) function is used to sort an array of arrays (or objects) based on their first elements.
                    // In this code, each array's first element is a timestamp, and the sort function arranges them in ascending order.
                    // The arrow function (a, b) => a[0] - b[0] takes two parameters, 'a' and 'b', which represent two elements of the array being sorted.
                    // The function calculates the difference between the first element of 'a' and 'b':
                    // - If the result is negative, 'a' is placed before 'b'.
                    // - If the result is positive, 'a' is placed after 'b'.
                    // - If the result is zero, the order of 'a' and 'b' relative to each other does not change.
                    // This sorting method ensures that the data is ordered chronologically, which is crucial for correctly displaying data in time-sensitive charts.
                    }).sort((a, b) => a[0] - b[0]); 
    
                    // If no data is received, logs a message and returns early.
                    if (seriesData.length == 0) {
                        console.log('Got no data. Ignore');
                        return;
                    }
    
                    // Initializes a Highcharts stock chart in the specified container.
                    Highcharts.stockChart(containerId, {
                        rangeSelector: {
                            buttons: [{
                                type: 'second',
                                count: 1,
                                text: '1s'
                            }, {
                                type: 'minute',
                                count: 1,
                                text: '1m'
                            }, {
                                type: 'hour',
                                count: 1,
                                text: '1h'
                            }, {
                                type: 'all',
                                text: 'All'
                            }],
                            inputEnabled: true, // enables input box
                            selected: 1 // selects the 1 minute button by default
                        },
                        title: {
                            text: title
                        },
                        xAxis: {
                            crosshair: true,
                            type: 'datetime',
                            // Ensure tickInterval is set correctly; here it should likely be in milliseconds if showing seconds
                            tickInterval: 1
                        },
                        yAxis: {
                            title: {
                                text: 'Price'
                            }
                        },
                        series: [{
                            type: type,
                            name: title,
                            data: seriesData,
                            tooltip: {
                                valueDecimals: 2
                            },
                            dataGrouping: {
                                enabled: true // consider disabling data grouping for 1-second or 1-minute data
                            },
                            color: type === 'line' ? undefined : 'red', // Blue for line, red for candlestick
                            upColor: type === 'candlestick' ? 'green' : undefined, // Green for up days in candlestick
                            lineColor: type === 'candlestick' ? 'black' : undefined, // Black line color for candlestick wicks
                            upLineColor: type === 'candlestick' ? 'black' : undefined, // Black line color for candlestick up wicks
                            marker: { 
                                enabled: true,
                                radius: 3, 
                                fillColor: 'blue' 
                            }
                        }],
                        tooltip: {
                            formatter: function() {
                                const dateStr = Highcharts.dateFormat('%d-%m-%Y %H:%M:%S', new Date(this.x));
                                switch (this.series.options.type) {
                                    case 'scatter':
                                        return dateStr + '<br>Value: ' + this.y;
                                    case 'candlestick':
                                        return dateStr +
                                            '<br>Open: ' + this.point.open +
                                            '<br>High: ' + this.point.high +
                                            '<br>Low: ' + this.point.low +
                                            '<br>Close: ' + this.point.close;
                                    default:
                                        return dateStr + '<br>Value: ' + this.y;
                                }
                            }
                        }
                    });
                })
                .catch(error => {
                    // Logs an error message in the console if the fetch operation fails.
                    console.error('Error fetching data:', error);
                });
        }
    </script>
    </body>
</html>
