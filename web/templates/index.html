<!DOCTYPE html>
<html>
<head>
    <title>Financial Chart</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script src="https://code.highcharts.com/stock/highstock.js"></script>
    <script src="https://code.highcharts.com/stock/modules/data.js"></script>
    <script src="https://code.highcharts.com/stock/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/stock/modules/accessibility.js"></script>
</head>
<body>
    <div style="margin-bottom: 10px;">
        <input type="text" id="startTimePicker" placeholder="Select Start Time" />
        <input type="number" id="durationHours" placeholder="Duration (hours)" min="1" max="72" />
        <button onclick="loadData()">Load Data</button>
    </div>
    <div id="container" style="height: 600px; min-width: 310px"></div>
    <script>
        // This is a shorthand for jQuery's document ready function. 
        // It waits for the DOM to be fully loaded and then executes the code inside the function.
        $(function() {
            $('#startTimePicker').daterangepicker({
                singleDatePicker: true, // Allows selecting only one date
                timePicker: true,
                timePicker24Hour: true,
                timePickerIncrement: 15, // Specifies the time picker increment in minutes
                startDate: moment().subtract(4, 'days'), // Default start time: 1 day ago
                locale: {
                    format: 'YYYY-MM-DDTHH:mm:ss.SSS[Z]'
                }
            });

            $('#durationHours').val(2); // Default duration to 2 hours

            loadData(); // Load data on page load with default values
        });

        function loadData() {
            var startTime = $('#startTimePicker').val();
            var duration = parseInt($('#durationHours').val());
            var endTime = moment(startTime).add(duration, 'hours').format('YYYY-MM-DDTHH:mm:ss.SSS[Z]');

            fetchData('BTC', startTime, endTime);
        }

        function fetchData(symbol, startDate, endDate, addData = false) {
            console.log(`Fetching data: ${symbol}, Start: ${startDate}, End: ${endDate}`);
            const url = `/price_data?symbol=${encodeURIComponent(symbol)}&start=${encodeURIComponent(startDate)}&end=${encodeURIComponent(endDate)}`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const seriesData = data.map(item => {
                        return [new Date(item.time).getTime(), item.price];
                    }).sort((a, b) => a[0] - b[0]);

                    if (seriesData.length == 0) {
                        console.log('Got no data. Ignore');
                        return;
                    }

                    Highcharts.stockChart('container', {
                        rangeSelector: {
                            selected: 1
                        },
                        title: {
                            text: `${symbol} Stock Price`
                        },
                        xAxis: {
                            type: 'datetime'
                        },
                        yAxis: {
                            title: {
                                text: 'Price'
                            }
                        },
                        series: [{
                            type: 'line',
                            name: symbol,
                            data: seriesData,
                            tooltip: {
                                valueDecimals: 2
                            }
                        }]
                    });
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                });
        }
    </script>
</body>
</html>
