<!DOCTYPE html>
<html>
<head>
    <title>Financial Chart</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script src="https://code.highcharts.com/stock/highstock.js"></script>
    <script src="https://code.highcharts.com/stock/modules/data.js"></script>
    <script src="https://code.highcharts.com/stock/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/stock/modules/accessibility.js"></script>
</head>
<body>
    <div style="margin-bottom: 10px;">
        <input type="text" id="startTimePicker" placeholder="Select Start Time" />
        <input type="number" id="durationHours" placeholder="Duration (hours)" min="1" max="72" />
        <button onclick="loadData()">Load Data</button>
    </div>
    <div id="container" style="height: 600px; min-width: 310px"></div>
    <script>
        $(function() {
            $('#startTimePicker').daterangepicker({
                singleDatePicker: true,
                timePicker: true,
                timePicker24Hour: true,
                timePickerIncrement: 15,
                startDate: moment().subtract(4, 'days'),
                locale: {
                    format: 'YYYY-MM-DDTHH:mm:ss.SSS[Z]'
                }
            });
        
            $('#durationHours').val(2); // Default duration to 2 hours
        
            loadConfigAndData(); // Load panels configuration and data on page load
        });
        
        function loadConfigAndData() {
            fetch('panels.json')
                .then(response => response.json())
                .then(panels => {
                    panels.forEach(panel => {
                        loadData(panel);
                    });
                })
                .catch(error => {
                    console.error('Error loading panel config:', error);
                });
        }
        
        function loadData(panel) {
            var startTime = $('#startTimePicker').val();
            var duration = parseInt($('#durationHours').val());
            var endTime = moment(startTime).add(duration, 'hours').format('YYYY-MM-DDTHH:mm:ss.SSS[Z]');
        
            panel.endpoints.forEach(endpoint => {
                fetchData(panel.symbol, startTime, endTime, endpoint.type, endpoint.url);
            });
        }
        
        function fetchData(symbol, startDate, endDate, type, url, addData = false) {
            console.log(`Fetching data: ${symbol}, Start: ${startDate}, End: ${endDate}`);
            fetch(`${url}?symbol=${encodeURIComponent(symbol)}&start=${encodeURIComponent(startDate)}&end=${encodeURIComponent(endDate)}`)
                .then(response => response.json())
                .then(data => {
                    const seriesData = data.map(item => {
                        if (type === 'line') {
                            return [new Date(item.time).getTime(), item.price];
                        } else if (type === 'ohlc') {
                            return [new Date(item.time).getTime(), item.open, item.high, item.low, item.close];
                        }
                    }).sort((a, b) => a[0] - b[0]);
        
                    if (seriesData.length == 0) {
                        console.log('Got no data. Ignore');
                        return;
                    }
        
                    Highcharts.stockChart('container', {
                        rangeSelector: {
                            selected: 1
                        },
                        title: {
                            text: `${symbol} Price Chart`
                        },
                        xAxis: {
                            type: 'datetime'
                        },
                        yAxis: {
                            title: {
                                text: 'Price'
                            }
                        },
                        series: [{
                            type: type === 'ohlc' ? 'candlestick' : 'line',
                            name: symbol,
                            data: seriesData,
                            tooltip: {
                                valueDecimals: 2
                            }
                        }]
                    });
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                });
        }
        </script>
        </body>
</html>
